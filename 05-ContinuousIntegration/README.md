# Creating a CI/CD Pipeline on AWS for Elastic Beanstalk

In this section you will create a CI/CD Pipeline on AWS for your java application using CodeCommit, CodeBuild, CodeDeploy and CodePipeline. This application will be deployed on Elastic Beanstalk.


## 1. Creating a repository and pushing the source code

AWS CodeCommit is a fully-managed source control service that makes it easy for companies to host secure and highly scalable private Git repositories.

In order to start using it, let's open the AWS Console and in the `CodeCommit` screen click in the `Get started` Button:

![code-commit-gettingstarted](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/ccgetstarted.png)

Now, choose a repository name and click in `Create repository`:

![create-repository](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/create-repository.png)

In the `Configure email notifications` screen, just click in `Skip`.

After creating our repository, AWS CodeCommit is going to show how to start working with the repository itself. You will need to follow the steps in this screen, in order to have an IAM user that can use your new repository.

![code-commit-instructions](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/code-commit-instructions.png)

After executing all these steps, you will clone your repository inside your home folder.

>NOTE: Remember to not clone your repository inside your application folder.

When cloning your repository, you will have a new folder named just as your repository. Now, you will copy all your application files from the directory. You can use the following command:

    cp -r eb-workshop/* eb-workshop-app/

After copying your application files let's run the following commands to execute our first commit:

    cd eb-workshop-app/
    git add --all
    git commit -m 'First commit'
    git push

This will send our source code to the new repository on CodeCommit.
You can check your source code in your repository looking at the AWS Console:

![checking-commit](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/checking-commit.png)

## 2. Creating a S3 bucket to store our artifacts

Let's now create a new bucket in order to store our artifacts that will be generated by the CodeBuild. To create a new bucket just run the command:

    aws s3 mb s3://<your-name>-eb-workshop-artifacts

>NOTE: To run this command, you will need to have the `aws cli` installed. You can see [here](https://github.com/bemer/aws-eb-workshop/tree/master/01-SetupEnvironment#install-aws-cli) how to install and configure it.


## 3. Creating a CodeBuild Project

AWS CodeBuild is a fully managed build service that compiles source code, runs tests, and produces software packages that are ready to deploy.

In order to start taking advantage of this service, open the CodeBuild product page in the AWS Console. You will face the `Build projects` page. In this page, click in `Create project`:

![create-project](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/create-project.png)

Now, we need to fill all the fields. Here are the informations you will need to enter:

    Project name: eb-workshop
    Source provider: AWS CodeCommit
    Repository: <Your CodeCommit Repository name>
    Environment image: Use an image managed by AWS CodeBuild
    Operating system:  Ubuntu
    Runtime: Docker
    Runtime version: aws/codebuild/docker:17.09.0

Them, select the option `Insert build commands` and click in switch to editor. You will need to add the following content:

    version: 0.2
    phases:

      build:
        commands:
           \- zip -r eb-workshop-app.zip ./*
    artifacts:
      files:
        \- eb-workshop-app.zip


Now, in `Artifacts`, select:

    Type: Amazon S3
    Path: artifacts/
    Namespace type: Build ID
    Bucket name: eb-workshop-artifacts

And finally, click in `Continue` and them in `Save`.

You will be redirected to the `Build projects` screen, and now you will see your project. If you want to validate all the configurations, click in `Start build`:

![start-build](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/start-build.png)

Now, choose your branch (that will be `master`) and click in `Start build`:

![start-build-2](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/start-build-2.png)

After a few seconds, your build process will be finished and you will be able to see a zip file in your S3 bucket.

![build-completed](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/build-completed.png)

## 4. Creating a CodePipeline

AWS CodePipeline is a continuous delivery service you can use to model, visualize, and automate the steps required to release your software.

So, let's create our pipeline that will deploy our application in the Elastic Beanstalk environment.

Open your console and go to the `CodePipeline` page. There, click in `Get Started`.

Now, add a name to your Pipeline and click in `Next`:

![code-pipeline-name](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/code-pipeline-name.png)

Now, select `AWS CodeCommit` as your Source provider and your repository with the branch `master`. Click in `Next step`:

![source-location](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/source-location.png)

In the `Build` scree, select `AWS CodeBuild` as the Build provider and them the `eb-workshop` project that we just created:

![build-provider](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/build-provider.png)

On the `Deploy`, select `AWS Elastic Beanstalk` as your Deployment provider, them your application and the environment prod:

![deployment-provider](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/deployment-provider.png)

In the `Service Role` screen, just click in `Create role`. You will be redirected to a new screen, where you just need to create in `Allow`.

![create-role](https://github.com/bemer/aws-eb-workshop/blob/master/05-ContinuousIntegration/images/create-role.png)

In the review screen, just click in `Create pipeline`.
